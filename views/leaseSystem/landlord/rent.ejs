<%- include('../partials/header'); %>

    <body>
        <!-- show house data and rent data -->
        <div class="container mt-3">
            <div style="margin-top: 10px">
                <a href="/leaseSystem/landlord/manageEstate">back</a>
            </div>
            <div class="col-md-5 center-block" style="float: none; margin: auto">
                <div>
                    <h1 style="margin:auto" class="font-weight-bold">Rent</h2>
                </div>
                <div class="card">
                    <h4 style="margin:auto" class="font-weight-bold card-title mt-2">House Data</h4>

                    <div style="margin-top: 10px" class="card text-center">
                        <div class="input-group mb-3">
                            <span class="input-group-text">Title</span>
                            <input type="text" class="form-control" id="title" name="title" value="<%=HouseData.title%>"
                                readonly>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Owner Address</span>
                            <input type="text" class="form-control" id="userAddress" name="userAddress"
                                value="<%=address%>" readonly>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">House Address</span>
                            <input type="text" class="form-control" id="houseAddress" name="houseAddress"
                                value="<%=HouseData.houseAddress%>" readonly>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">House Area</span>
                            <input type="text" class="form-control" value="<%=HouseData.area%>" readonly>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Room Type</span>
                            <select class="form-select" id="roomType" name="roomType" readonly>
                                <option selected value="<%=HouseData.type%>" readonly>
                                    <%=HouseData.type%>
                                </option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Describe</label>
                            <input type="text" class="form-control" id="describe" name="describe"
                                value="<%=HouseData.describe%>" readonly>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Picture</label>
                            <input type="file" class="form-control" id="picture" name="picture" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- lease option -->
        <div class="container mt-3">
            <div class="col-md-5 center-block" style="float: none; margin: auto">
                <div class="card">
                    <h4 style="margin:auto" class="font-weight-bold card-title mt-2">Rent Data</h4>
                    <form name="rentForm" action="">
                        <!-- <div style="margin-top: 10px" class="card text-center"> -->
                        <div class="input-group mt-2">
                            <span class="input-group-text">Rent price</span>
                            <input type="number" min="0" class="form-control" id="price" name="price" value = "100">
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="month" id="month" value="month">
                            <label class="form-check-label" for="month">per month</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="year" id="year" value="year">
                            <label class="form-check-label" for="year">per year</label>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">time</span>
                            <input type="text" class="form-control" id="time" name="time">
                        </div>
                        <!-- </div> -->
                    </form>
                    <!-- <button id="upload">test upload</button> -->
                    <button type="submit" class="btn btn-primary" id="NewLease">upload</button>
                </div>
            </div>
        </div>
    </body>

    <script>

        var identityManagerABI, personalIdentityABI;
        var account;
        var contract_address = '<%= contract_address %>';

        const preventMalleability = (sig, ecdsa) => {
            const halfOrder = ecdsa.n.shrn(1);
            if (sig.s.cmp(halfOrder) === 1) {
                const bigNum = ecdsa.n;
                sig.s = bigNum.sub(sig.s);
            }
            return sig;
        };

        function sign(privateKey, digest) {
            const signKey = ecdsa.keyFromPrivate(privateKey, 'hex');
            const sig = ecdsa.sign(Buffer.from(digest, 'hex'), signKey);
            var halfOrderSig = preventMalleability(sig, ecdsa);
            const signature = Buffer.from(halfOrderSig.toDER());
            var signature_string = '';
            for (var i = 0; i < signature.length; i++) {
                signature_string += signature[i].toString();
                signature_string += '/';
            }
            signature_string = signature_string.slice(0, -1);
            return signature_string;
        }

        function ajaxAwait(url, data) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: url,
                    dataType: 'json',
                    data: data,
                    success: function (res) {
                        console.log('success');
                        resolve(res);
                    },
                    fail: function (xhr, ajaxOptions, thrownError) {
                        console.log('fail');
                        reject(false);
                    },
                });
            });
        }

        function isNumber(value) {
            if (isNaN(value) | !value) {
                return false;
            }
            return true;
        }
        async function buildListener() {
            var identityManagerInstance = new web3.eth.Contract(
                identityManagerABI,
                contract_address
            );
            var personalIdentityAddress = await identityManagerInstance.methods
                .getAccessManagerAddress(account)
                .call({ from: account });

            var personalIdentityInstance = new web3.eth.Contract(
                personalIdentityABI,
                personalIdentityAddress
            );

            $('#NewLease').on('click', async function (e) {
                let price = $("#price").val();
                let userAddress = $("#userAddress").val();
                let houseAddress = $("#houseAddress").val();

                if (!isNumber(price)) {
                    return alert("rent price must be a numbers!");
                }

                // userPubkey, estateAddress, rent, dataHash
                let response, result;
                response = await ajaxAwait(
                    '/leaseSystem/landlord/NewLease',
                    {
                        address: userAddress,
                        estateAddress: houseAddress,
                        rent: price,
                        dataHash: "test"
                    }
                );
                console.log('response = ' + response.result);
                if (response.error) {
                    return alert(`error :${response.result}`);
                }
                let encryptKey = await personalIdentityInstance.methods
                    .getEncryptMaterial('HLFPrivateKey')
                    .call({ from: account });
                let privateKey = await ethereum.request({
                    method: 'eth_decrypt',
                    params: [encryptKey, account],
                });
                let signature_string;
                signature_string = sign(privateKey, response.digest);
                response = await ajaxAwait(
                    '/leaseSystem/proposalAndCreateCommit',
                    { signature: signature_string, func: 'NewLease' }
                );
                if (response.error) {
                    return alert(`error :${response.result}`);
                }

                result = response.result;
                signature_string = sign(privateKey, response.commitDigest);
                response = await ajaxAwait('/leaseSystem/commitSend', {
                    signature: signature_string,
                    func: 'NewLease',
                    estateAddress: houseAddress
                });
                if (response.error) {
                    return alert(`error: ${response.result}`);
                }

                if (alert(`${result}`)) {
                    window.location.reload();
                }
                window.location.reload();
            });
        }

        async function main() {
            let accounts = await web3.eth.getAccounts();
            account = accounts[0];
            identityManagerABI = await fetch(
                '../../contracts/IdentityManager.json'
            );
            personalIdentityABI = await fetch(
                '../../contracts/PersonalIdentity.json'
            );
            identityManagerABI = await identityManagerABI.json();
            identityManagerABI = identityManagerABI.output.abi;
            personalIdentityABI = await personalIdentityABI.json();
            personalIdentityABI = personalIdentityABI.output.abi;

            // console.log('identityManagerABI = ' + JSON.stringify(identityManagerABI));
            // console.log('personalIdentityABI = ' + JSON.stringify(personalIdentityABI));

            buildListener();
        }

        main();

    </script>
    <%- include('../partials/footer'); %>