<%- include('./partials/header'); %>

    <body>
        <div class="container mt-3">
            <div style="margin-top: 10px">
                <a href="/leaseSystem">back</a>
            </div>
            <div class="col-md-5 center-block" style="float: none; margin: auto">
                <div style="margin-top: 10px" class="card text-center">
                    <div style="font-size: 1.5rem; font-weight: bold" class="card-header">
                        favorite
                    </div>
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th scope="col">owner address</th>
                                <th scope="col">house address</th>
                                <th scope="col">btn</th>
                                <th scope="col">sign</th>
                                <th scope="col">acc</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% for (let index=0; index < favorite.length; index++) {%>
                                <tr>
                                    <td>
                                        <input type="text" id="uploader-<%= index %>" name="uploader-<%= index %>"
                                            value="<%=favorite[index].ownerAddress%>" readonly>
                                    </td>
                                    <td>
                                        <input type="text" id="houseAddress-<%= index %>"
                                            name="houseAddress-<%= index %>" value="<%=favorite[index].houseAddress%>"
                                            readonly>
                                    </td>
                                    <td><button class="btn btn-primary" id="details-<%= index %>">details</button></td>
                                    <td><button class="btn btn-primary" id="signing-<%= index %>">view and sign
                                            agreement</button></td>
                                    <td><button class="btn btn-primary" id="upload-<%= index %>">acc</button></td>
                                </tr>
                                <%} %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-5 center-block" style="float: none; margin: auto">
                <div style="margin-top: 10px" class="card text-center">
                    <div style="font-size: 1.5rem; font-weight: bold" class="card-header">
                        Your on leasing house
                    </div>
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th scope="col">house address</th>
                                <th scope="col">person want to sign</th>
                                <th scope="col">Create Agreement</th>
                                <th scope="col">acc</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% for (let index=0; index < rentData.length; index++) {%>
                                <tr>
                                    <td>
                                        <input type="text" id="estateAddress-<%= index %>"
                                            name="estateAddress-<%= index %>" value="<%=rentData[index].estateAddress%>"
                                            readonly>
                                    </td>
                                    <td>
                                        <select name="signer-<%= index %>" id="signer-<%= index %>">
                                            <option value="" selected>---select a person to sign---</option>
                                            <% for (let i=0; i < signerList.length; i++) {
                                                if(signerList[i].houseAddress==rentData[index].estateAddress) {%>
                                                <option value="<%= signerList[i].address %>">
                                                    <%= signerList[i].address %>
                                                </option>
                                                <% } } %>
                                        </select>
                                    </td>

                                    <td><button class="btn btn-primary" id="createAgreement-<%= index %>">Create
                                            Agreement</button></td>
                                    <td><button class="btn btn-primary" id="request-<%= index %>">acc</button></td>
                                </tr>
                                <%} %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </body>
    <script>
        var address = '<%= address %>';
        var favorite = JSON.parse('<%- JSON.stringify(favorite) %>');
        var signerList = JSON.parse('<%- JSON.stringify(signerList) %>');
        var rentData = JSON.parse('<%- JSON.stringify(rentData) %>');
        async function buildListener() {
            for (let i = 0; i < favorite.length; i++) {

                $(`#details-${i}`).on('click', async function (e) {
                    let houseAddress = $(`#houseAddress-${i}`).val();
                    let uploaderAddress = $(`#uploader-${i}`).val();
                    $.ajax({
                        url: '/leaseSystem/leaseManage/leasePage',
                        data: {
                            "addr": houseAddress,
                            "uploader": uploaderAddress
                        },
                        type: 'post'
                    }).then((res) => {
                        if (res.url) {
                            window.location.href = res.url;
                        }
                    })
                })

                $(`#signing-${i}`).on('click', async function (e) {
                    let houseAddress = $(`#houseAddress-${i}`).val();
                    let uploaderAddress = $(`#uploader-${i}`).val();
                    let result = await $.ajax({
                        url: '/leaseSystem/agreement/agreementPage',
                        data: {
                            ownerAddress: uploaderAddress,
                            tenantAddress: address,
                            houseAddress: houseAddress
                        },
                        type: 'post'
                    }).then((res) => {
                        // console.log(res);
                        if (res.msg) {
                            alert(res.msg);
                            return;
                        }
                        else if (res.url) {
                            window.location.href = res.url;
                        }
                    })
                })

                $(`#upload-${i}`).on('click', async function (e) {
                    let houseAddress = $(`#houseAddress-${i}`).val();
                    let uploaderAddress = $(`#uploader-${i}`).val();
                    $.ajax({
                        type: 'POST',
                        url: '/leaseSystem/leaseManage/upload',
                        dataType: 'json',
                        data: {
                            ownerAddress: uploaderAddress,
                            houseAddress: houseAddress
                        },
                        success: function (res) {
                            console.log('success');
                            console.log(res);

                            if (res.url) {
                                window.location.href = res.url;
                            }
                        },
                        fail: function (xhr, ajaxOptions, thrownError) {
                            console.log('fail');
                            reject(false);
                        },
                    });
                })

            }

            for (let index = 0; index < rentData.length; index++) {
                $(`#createAgreement-${index}`).on('click', async function (e) {
                    let estateAddress = $(`#estateAddress-${index}`).val();
                    let signer = $(`#signer-${index}`).val();
                    if (signer == '') {
                        alert("please select a person");
                        return;
                    }

                    $.ajax({
                        url: '/leaseSystem/leaseManage/agreement',
                        data: {
                            "signer": signer,
                            "estateAddress": estateAddress
                        },
                        type: 'post'
                    }).then((res) => {
                        if (res.url) {
                            window.location.href = res.url;
                        }
                    })
                })

                $(`#request-${index}`).on('click', async function (e) {
                    let estateAddress = $(`#estateAddress-${index}`).val();
                    let signer = $(`#signer-${index}`).val();
                    $.ajax({
                        type: 'POST',
                        url: '/leaseSystem/dataSharing/request',
                        dataType: 'json',
                        data: {
                            ownerAddress: address,
                            tenantAddress: signer,
                            houseAddress: estateAddress,
                        },
                        success: function (res) {
                            console.log('success');
                            console.log(res);

                            if (res.url) {
                                window.location.href = res.url;
                            }
                        },
                        fail: function (xhr, ajaxOptions, thrownError) {
                            console.log('fail');
                            reject(false);
                        },
                    });
                })
            }

        }
        buildListener();
    </script>
    <%- include('./partials/footer'); %>