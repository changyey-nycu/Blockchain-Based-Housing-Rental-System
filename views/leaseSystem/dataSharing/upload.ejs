<%- include('../partials/header'); %>

    <body>
        <div class="container mt-3">
            <div class="col-md-5 center-block" style="float: none; margin: auto">
                <div style="margin-top: 10px">
                    <a href="/leaseSystem/leaseManage">back</a>
                </div>
                <div style="margin-top: 10px" class="card text-center">
                    <div class="card-header">
                        <h4 style="margin:auto" class="font-weight-bold">Requester Data</h4>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Owner Address</span>
                        <input type="text" class="form-control" id="uploader" name="uploader"
                            value="<%=houseData.ownerAddress%>" readonly>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">House Address</span>
                        <input type="text" class="form-control" id="houseAddress" name="houseAddress"
                            value="<%=houseData.houseAddress%>" readonly>
                    </div>
                </div>
            </div>
        </div>


        <div class="container mt-3">
            <div class="col-md-5 center-block" style="float: none; margin: auto">
                <div style="margin-top: 10px" class="card text-center">
                    <div class="card-header">
                        <h4 style="margin:auto" class="font-weight-bold">Your Data</h4>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Tenant Address</span>
                        <input type="text" class="form-control" id="tenantAddress" name="tenantAddress"
                            value="<%=tenantData.address%>" readonly>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Tenant Pubkey</span>
                        <input type="text" class="form-control" id="tenantPubkey" name="tenantPubkey"
                            value="<%=tenantData.pubkey%>" readonly>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-3">
            <div class="col-md-5 center-block" style="float: none; margin: auto">
                <div style="margin-top: 10px" class="card text-center">
                    <div class="card-header">
                        <h4 style="margin:auto" class="font-weight-bold">Request</h4>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Duration</span>
                        <input type="text" class="form-control" id="duration" name="duration" value="">
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Agreement Content</span>
                        <input type="text" class="form-control" id="content" name="content" value="">
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Create Agreement</span>
                        <input class="btn btn-primary" id="CreateAgreement" value="Create">
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Sign Agreement</span>
                        <input class="btn btn-primary" id="SignAgreement" value="Sign" disabled>
                    </div>
                </div>
            </div>
        </div>

    </body>
    <script>
        var identityManagerABI, personalIdentityABI;
        var account;
        var contract_address = '<%= contract_address %>';

        var houseData = JSON.parse('<%- JSON.stringify(houseData) %>');
        var rentData = JSON.parse('<%- JSON.stringify(rentData) %>');
        var ownerData = JSON.parse('<%- JSON.stringify(ownerData) %>');
        var tenantData = JSON.parse('<%- JSON.stringify(tenantData) %>');

        const preventMalleability = (sig, ecdsa) => {
            const halfOrder = ecdsa.n.shrn(1);
            if (sig.s.cmp(halfOrder) === 1) {
                const bigNum = ecdsa.n;
                sig.s = bigNum.sub(sig.s);
            }
            return sig;
        };

        function sign(privateKey, digest) {
            const signKey = ecdsa.keyFromPrivate(privateKey, 'hex');
            const sig = ecdsa.sign(Buffer.from(digest, 'hex'), signKey);
            var halfOrderSig = preventMalleability(sig, ecdsa);
            const signature = Buffer.from(halfOrderSig.toDER());
            var signature_string = '';
            for (var i = 0; i < signature.length; i++) {
                signature_string += signature[i].toString();
                signature_string += '/';
            }
            signature_string = signature_string.slice(0, -1);
            return signature_string;
        }

        function ajaxAwait(url, data) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: url,
                    dataType: 'json',
                    data: data,
                    success: function (res) {
                        console.log('success');
                        resolve(res);
                    },
                    fail: function (xhr, ajaxOptions, thrownError) {
                        console.log('fail');
                        reject(false);
                    },
                });
            });
        }

        async function buildListener() {
            var identityManagerInstance = new web3.eth.Contract(
                identityManagerABI,
                contract_address
            );
            var personalIdentityAddress = await identityManagerInstance.methods
                .getAccessManagerAddress(account)
                .call({ from: account });

            var personalIdentityInstance = new web3.eth.Contract(
                personalIdentityABI,
                personalIdentityAddress
            );
            $('#CreateAgreement').on('click', async function (e) {
                console.log(houseData);
                console.log(rentData);
                console.log(ownerData);
                console.log(tenantData);
                let content = $("#content").val();
                let duration = $("#duration").val();
                let leaseData = {
                    "content": content,
                    "duration": duration
                }

                let Data = {
                    ownerAddress: ownerData.address,
                    tenantAddress: tenantData.address,
                    houseAddress: houseData.houseAddress,
                    area: houseData.area,
                    time: leaseData.duration,
                    rent: rentData.rent,
                    content: leaseData.content,
                    ownerPubkey: ownerData.pubkey,
                    tenantPubkey: tenantData.pubkey,
                }
                console.log(Data);

                response = await ajaxAwait(
                    '/leaseSystem/agreement/createAgreement',
                    {
                        ownerAddress: ownerData.address,
                        tenantAddress: tenantData.address,
                        houseAddress: houseData.houseAddress,
                        area: houseData.area,
                        time: leaseData.duration,
                        rent: rentData.rent,
                        content: leaseData.content,
                        ownerPubkey: ownerData.pubkey,
                        tenantPubkey: tenantData.pubkey
                    }
                );
                // console.log(response.toString());

                alert(response.msg);
                window.location.reload();
            })

            $('#SignAgreement').on('click', async function (e) {
                // userPubkey, estateAddress, rent, dataHash
                let response, result;
                response = await ajaxAwait(
                    '/leaseSystem/landlord/NewLease',
                    {
                        address: userAddress,
                        estateAddress: houseAddress,
                        rent: price,
                        dataHash: "test"
                    }
                );
                console.log('response = ' + response.result);
                if (response.error) {
                    return alert(`error :${response.result}`);
                }
                let encryptKey = await personalIdentityInstance.methods
                    .getEncryptMaterial('HLFPrivateKey')
                    .call({ from: account });
                let privateKey = await ethereum.request({
                    method: 'eth_decrypt',
                    params: [encryptKey, account],
                });
                let signature_string;
                signature_string = sign(privateKey, response.digest);
                response = await ajaxAwait(
                    '/leaseSystem/proposalAndCreateCommit',
                    { signature: signature_string, func: 'NewLease' }
                );
                if (response.error) {
                    return alert(`error :${response.result}`);
                }

                result = response.result;
                signature_string = sign(privateKey, response.commitDigest);
                response = await ajaxAwait('/leaseSystem/commitSend', {
                    signature: signature_string,
                    func: 'NewLease',
                    estateAddress: houseAddress
                });
                if (response.error) {
                    return alert(`error: ${response.result}`);
                }

                if (alert(`${result}`)) {
                    window.location.reload();
                }
                window.location.reload();
            });
        }

        async function main() {
            let accounts = await web3.eth.getAccounts();
            account = accounts[0];
            identityManagerABI = await fetch(
                '../../contracts/IdentityManager.json'
            );
            personalIdentityABI = await fetch(
                '../../contracts/PersonalIdentity.json'
            );
            identityManagerABI = await identityManagerABI.json();
            identityManagerABI = identityManagerABI.output.abi;
            personalIdentityABI = await personalIdentityABI.json();
            personalIdentityABI = personalIdentityABI.output.abi;

            // console.log('identityManagerABI = ' + JSON.stringify(identityManagerABI));
            // console.log('personalIdentityABI = ' + JSON.stringify(personalIdentityABI));

            buildListener();
        }

        main();

    </script>
    <%- include('../partials/footer'); %>